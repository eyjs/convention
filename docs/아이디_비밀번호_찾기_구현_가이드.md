# 아이디/비밀번호 찾기 구현 가이드

## 시스템 구조

### 1. User 자동생성 방식

참석자(Guest) 생성 시 User 계정이 자동으로 생성됩니다.

```
AdminController.CreateGuest 실행 시:
1. Guest 레코드 생성 (AccessToken 생성)
2. 비밀번호 결정
   - 수기 입력 > 주민번호 앞6자리 > "123456"
3. User 계정 생성
   - LoginId = AccessToken (64자리 고유값)
   - PasswordHash = 해시된 비밀번호
4. Guest.UserId 연결
```

**문제점**: LoginId가 64자리 GUID이므로 사용자가 기억하기 어려움  
**해결책**: 아이디/비밀번호 찾기 기능 제공

---

## 2. 구현된 기능

### 백엔드

#### 서비스
- **SmsService**: SMS 발송 (회사 MSSQL Procedure 호출 가정)
- **VerificationService**: 인증번호 생성/검증 (메모리 기반, 5분 유효)

#### API 엔드포인트

**아이디 찾기**
```
POST /api/accountrecovery/find-id/send-code
Body: { name, phoneNumber }
→ 인증번호 SMS 발송

POST /api/accountrecovery/find-id/verify
Body: { name, phoneNumber, code }
→ LoginId 반환
```

**비밀번호 찾기**
```
POST /api/accountrecovery/reset-password/send-code
Body: { loginId, name, phoneNumber }
→ 인증번호 SMS 발송

POST /api/accountrecovery/reset-password/verify
Body: { loginId, name, phoneNumber, code, newPassword }
→ 비밀번호 재설정
```

### 프론트엔드

- `/find-id`: 아이디 찾기 페이지
- `/find-password`: 비밀번호 찾기 페이지
- 로그인 화면에 링크 추가

---

## 3. SMS 서비스 연동 (TODO)

현재는 SMS 발송을 가정한 상태입니다. 실제 연동 시:

### SmsService.cs 수정

```csharp
public async Task<bool> SendVerificationCodeAsync(string phoneNumber, string code)
{
    try
    {
        // 회사 MSSQL Procedure API 호출
        using var connection = new SqlConnection(_connectionString);
        await connection.OpenAsync();
        
        using var command = new SqlCommand("sp_SendSMS", connection);
        command.CommandType = CommandType.StoredProcedure;
        command.Parameters.AddWithValue("@PhoneNumber", phoneNumber);
        command.Parameters.AddWithValue("@Message", $"[행사관리] 인증번호: {code}");
        
        var result = await command.ExecuteScalarAsync();
        return Convert.ToBoolean(result);
    }
    catch (Exception ex)
    {
        _logger.LogError(ex, "SMS 발송 실패: {Phone}", phoneNumber);
        return false;
    }
}
```

또는 HTTP API 호출:

```csharp
public async Task<bool> SendVerificationCodeAsync(string phoneNumber, string code)
{
    try
    {
        var response = await _httpClient.PostAsJsonAsync(
            "https://company-sms-api.com/send",
            new { 
                phone = phoneNumber, 
                message = $"[행사관리] 인증번호: {code}" 
            }
        );
        
        return response.IsSuccessStatusCode;
    }
    catch (Exception ex)
    {
        _logger.LogError(ex, "SMS 발송 실패: {Phone}", phoneNumber);
        return false;
    }
}
```

### appsettings.json 설정 추가

```json
{
  "SmsSettings": {
    "ApiUrl": "https://company-sms-api.com/send",
    "ApiKey": "your-api-key",
    "ConnectionString": "Server=..."
  }
}
```

---

## 4. 프로세스 흐름

### 아이디 찾기

```
1. 사용자: 이름 + 전화번호 입력
   ↓
2. 서버: User 조회 (이름 + 전화번호)
   ↓
3. 서버: 인증번호 생성 (6자리)
   ↓
4. 서버: SMS 발송 (TODO: 실제 API 연동)
   ↓
5. 사용자: 인증번호 입력
   ↓
6. 서버: 인증번호 검증
   ↓
7. 서버: LoginId 반환
   ↓
8. 사용자: LoginId 확인 및 로그인
```

### 비밀번호 찾기

```
1. 사용자: 아이디 + 이름 + 전화번호 입력
   ↓
2. 서버: User 조회 (LoginId + 이름 + 전화번호)
   ↓
3. 서버: 인증번호 생성
   ↓
4. 서버: SMS 발송
   ↓
5. 사용자: 인증번호 + 새 비밀번호 입력
   ↓
6. 서버: 인증번호 검증
   ↓
7. 서버: 비밀번호 해시 후 업데이트
   ↓
8. 사용자: 새 비밀번호로 로그인
```

---

## 5. 보안 고려사항

### 인증번호
- **유효시간**: 5분
- **저장위치**: 메모리 (VerificationService)
- **형식**: 6자리 랜덤 숫자
- **재사용 방지**: 검증 성공 시 즉시 삭제

### LoginId 마스킹
```csharp
private string MaskLoginId(string loginId)
{
    // 예: "abcd1234efgh5678" → "abcd********5678"
    var visible = 4;
    var masked = loginId.Length - (visible * 2);
    return $"{loginId[..visible]}{new string('*', masked)}{loginId[^visible..]}";
}
```

### Rate Limiting (권장)
```csharp
// TODO: IP별 인증번호 요청 제한
// 예: 1시간에 5회까지
```

---

## 6. 테스트 방법

### 개발 환경 (SMS 발송 없이)

1. 로그에서 인증번호 확인:
```
2024-10-12 15:30:45 [Information] 인증번호 생성: find-id:01012345678 - 123456 (만료: 2024-10-12 15:35:45)
```

2. 프론트엔드에서 해당 인증번호 입력

### 프로덕션 환경

1. SmsService 실제 API 연동
2. 실제 전화번호로 SMS 수신 확인
3. 인증번호 입력 후 기능 테스트

---

## 7. 파일 구조

```
Backend:
├── Controllers/
│   └── AccountRecoveryController.cs  (아이디/비밀번호 찾기 API)
├── Services/
│   ├── SmsService.cs                  (SMS 발송)
│   └── VerificationService.cs         (인증번호 관리)
└── Program.cs                          (DI 등록)

Frontend:
├── views/
│   ├── FindId.vue                     (아이디 찾기 화면)
│   ├── FindPassword.vue               (비밀번호 찾기 화면)
│   └── LoginView.vue                  (로그인 화면 - 링크 추가)
└── router/
    └── index.js                       (라우팅 설정)

Docs:
├── 시스템_구조_설계.md
├── User_자동생성_방식.md
└── 아이디_비밀번호_찾기_구현_가이드.md
```

---

## 8. 다음 단계

- [ ] 회사 SMS API 실제 연동
- [ ] Rate Limiting 구현
- [ ] 인증번호 재발송 기능
- [ ] 인증번호 만료 타이머 UI 추가
- [ ] 테스트 코드 작성
